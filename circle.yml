machine:
  timezone: Europe/Paris

  environment:
    PACKER_VERSION: 0.8.6
    TERRAFORM_VERSION:

dependencies:
  pre:
    - >
      sudo apt-get install -qq wget unzip &&
      pushd /usr/bin &&
      echo "Downloading packer ${PACKER_VERSION}..." &&
      sudo wget --no-verbose https://dl.bintray.com/mitchellh/packer/packer_${PACKER_VERSION}_linux_amd64.zip &&
      echo "Installing packer ${PACKER_VERSION}..." &&
      sudo unzip packer_${PACKER_VERSION}_linux_amd64.zip &&
      sudo rm packer_${PACKER_VERSION}_linux_amd64.zip &&
      sudo wget --no-verbose https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip &&
      sudo unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip &&
      sudo rm terraform_${PACKER_VERSION}_linux_amd64.zip &&

test:
  override:
    - |
      sudo mkdir -p /etc/gcloud
      echo "{\"type\": \"service_account\", \"project_id\": \"hyperion-k8s\", \"private_key_id\": \"xxxxxxxxxx\", \"private_key\": \"-----BEGIN PRIVATE KEY-----\nxxxxxn-----END PRIVATE KEY-----\n\",  \"client_email\": \"hyperion-k8s\", \"client_id\": \"1xxxxxxx\", \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\", \"token_uri\": \"https://accounts.google.com/o/oauth2/token\", \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\", \"client_x509_cert_url\": \"https://www.googleapis.com/\" }" > /tmp/account.json
      sudo mv /tmp/account.json /etc/gcloud/
    - packer version
    - cd packer/google/ && packer validate --var-file=settings.json hyperion.json
    - cd packer/ec2 && packer validate --var-file=settings.json hyperion.json
    - cd packer/digitalocean && packer validate --var-file=settings.json hyperion.json
    - cd terraform/google && terraform plan --var-file=variables.tf
